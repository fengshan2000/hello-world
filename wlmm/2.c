// wifi 中 四次握手 生成 MIC

#include <stdio.h>
#include<stdlib.h>
#include <string.h>
#include <openssl/hmac.h>


int main(int argc,char * argv[])
{            
    int i,j;
    
    static unsigned char password[]="081503wq";
    static unsigned char ssid[]={'9','8','0','T','i'};
//     test case 1
//     static unsigned char password[]="password";
//     static unsigned char ssid[]={'I','E','E','E'};
    
    unsigned char psk1_num[4]={0x00,0x00,0x00,0x01};
    unsigned char psk2_num[4]={0x00,0x00,0x00,0x02};
    
//     psk 
    unsigned char tem_c[20];
    unsigned char psk_1[20];
    unsigned char psk_2[20];
    unsigned char psk[32]=
        {0x0d ,0xc0 ,0xd6 ,0xeb ,0x90 ,0x55 ,0x5e ,0xd6 ,
         0x41 ,0x97 ,0x56 ,0xb9 ,0xa1 ,0x5e ,0xc3 ,0xe3 ,
         0x20 ,0x9b ,0x63 ,0xdf ,0x70 ,0x7d ,0xd5 ,0x08 ,
         0xd1 ,0x45 ,0x81 ,0xf8 ,0x98 ,0x27 ,0x21 ,0xaf };
    
    int password_len=strlen(password),
         ssid_len=strlen(ssid),         
         psk1_num_len=4,
         psk2_num_len=4,
         psk_len=32,
         psk_1_len=20,
         psk_2_len=20;    
    
    HMAC_CTX *ctx=NULL,
             *hctx=NULL;
        
    ctx=HMAC_CTX_new();
    hctx=HMAC_CTX_new();
        
    HMAC_Init_ex(ctx,password,password_len,EVP_sha1(),NULL);
    HMAC_CTX_copy(hctx,ctx);
    HMAC_Update(hctx,ssid,ssid_len);
    HMAC_Update(hctx,psk1_num,psk1_num_len);
    HMAC_Final(hctx,psk_1,&psk_1_len);     
    for(j=0;j<psk_1_len;j++) tem_c[j]=psk_1[j];        
    
//     for(i=0;i<20;i++)
//         printf("%02X ",psk_1[i]);
    for(i=1;i<4096;i++)
    {        
        HMAC_CTX_copy(hctx,ctx);
        
        
        HMAC_Update(hctx,psk_1,psk_1_len);
        HMAC_Final(hctx,psk_1,&psk_1_len);        
                        
        for(j=0;j<psk_1_len;j++) tem_c[j]=psk_1[j]^tem_c[j];                    
    }
    
    for(i=0;i<psk_1_len;i++)
         psk_1[i]=tem_c[i];
    
    ctx=HMAC_CTX_new();
    hctx=HMAC_CTX_new();
    
    HMAC_Init_ex(ctx,password,password_len,EVP_sha1(),NULL);
    HMAC_CTX_copy(hctx,ctx);
    HMAC_Update(hctx,ssid,ssid_len);
    HMAC_Update(hctx,psk2_num,psk2_num_len);
    HMAC_Final(hctx,psk_2,&psk_2_len);
    for(j=0;j<psk_2_len;j++) tem_c[j]=psk_2[j];        
    
//     for(i=0;i<20;i++)
//         printf("%02X ",psk_1[i]);
    for(i=1;i<4096;i++)
    {
        HMAC_CTX_copy(hctx,ctx);        
        HMAC_Update(hctx,psk_2,psk_2_len);
        HMAC_Final(hctx,psk_2,&psk_2_len);        
        for(j=0;j<psk_2_len;j++) 
            tem_c[j]=psk_2[j]^tem_c[j];
        
    }    
    
    for(i=0;i<psk_2_len;i++)
         psk_2[i]=tem_c[i];        
    for(i=0;i<psk_1_len;i++)
        psk[i]=psk_1[i];
    for(;i<psk_len;i++)
        psk[i]=psk_2[i-psk_1_len];
    
//     for(i=0;i<psk_len;i++)
//         printf("%02X ",psk[i]);       
//     printf("\n");        
//     ptk
    
    static unsigned char anonce[]={
        0x9a,0xb1,0xc8,0xbe,0xe4,0x33,0x73,0x54,
        0xcf,0x34,0xf8,0x5d,0xf1,0x91,0x52,0xfd,
        0xaf,0x07,0xe2,0x94,0x76,0x67,0x8e,0x0c,
        0xad,0x70,0x04,0x18,0x80,0xa9,0xb5,0xae};
    static unsigned char snonce[]={
        0x4a,0x14,0xb0,0xd1,0xe2,0x7a,0xea,0x0c,
        0x6a,0xfa,0x69,0xa6,0xd5,0x37,0xe4,0x94,
        0xe8,0x26,0xbf,0xf7,0x1d,0x0c,0xc1,0xc7,
        0xc9,0x52,0x65,0x4a,0xa7,0xd7,0xaf,0x06};
    static unsigned char aa[]={0x88,0x25,0x93,0x6a,0xd8,0x64};
    static unsigned char sa[]={0x00,0xec,0x0a,0xe8,0x29,0x65};
    unsigned char R[76]=
     {0xa0 ,0xa1 ,0xa1 ,0xa3 ,0xa4 ,0xa5 ,
      0xb0 ,0xb1 ,0xb2 ,0xb3 ,0xb4 ,0xb5,
      0xc0 ,0xc1 ,0xc2 ,0xc3 ,0xc4 ,0xc5 ,0xc6 ,0xc7 ,0xc8 ,0xc9 ,
      0xd0 ,0xd1 ,0xd2 ,0xd3 ,0xd4 ,0xd5 ,0xd6 ,0xd7 ,0xd8 ,0xd9 ,
      0xda ,0xdb ,0xdc ,0xdd ,0xde ,0xdf ,0xe0 ,0xe1 ,0xe2 ,0xe3 ,
      0xe4 ,0xe5,
      0xe0 ,0xe1 ,0xe2 ,0xe3 ,0xe4 ,0xe5 ,0xe6 ,0xe7 ,0xe8 ,0xe9 ,
      0xf0 ,0xf1 ,0xf2 ,0xf3 ,0xf4 ,0xf5 ,0xf6 ,0xf7 ,0xf8 ,0xf9 ,
      0xfa ,0xfb ,0xfc ,0xfd ,0xfe ,0xff ,0x00 ,0x01 ,0x02 ,0x03 ,
      0x04 ,0x05};    
    int R_len=76;    
    for(i=0;i<76;i++)
    {
        if(i<6) R[i]=sa[i];
        else if(i<12) R[i]=aa[i-6];
        else if(i<44) R[i]=snonce[i-12];
        else R[i]=anonce[i-44];
    }    
//     test R
                     
//       for(i=0;i<76;i++)
//           printf("%02X ",R[i]);       
    
    static unsigned char A[]="Pairwise key expansion";        
    unsigned char kck[16]={0};    
    unsigned char salt_0[]={0x00};    
    int A_len,
        kck_len=16;
    A_len=strlen(A);    
    
    ctx=HMAC_CTX_new();        
    HMAC_Init_ex(ctx,psk,psk_len,EVP_sha1(),NULL);
    HMAC_Update(ctx,A,A_len);
    HMAC_Update(ctx,salt_0,1);
    HMAC_Update(ctx,R,R_len);
    HMAC_Update(ctx,salt_0,1);
    HMAC_Final(ctx,kck,&kck_len);

//     for(i=0;i<kck_len;i++)
//         printf("%02X ",kck[i]);       
    kck_len=16;
    
//     mic
    static unsigned char message2[]={0x01,0x03,0x00,0x75,
        0x02,0x01,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x4a,0x14,0xb0,
        0xd1,0xe2,0x7a,0xea,0x0c,0x6a,0xfa,0x69,0xa6,0xd5,0x37,0xe4,0x94,0xe8,0x26,0xbf,
        0xf7,0x1d,0x0c,0xc1,0xc7,0xc9,0x52,0x65,0x4a,0xa7,0xd7,0xaf,0x06,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x16,0x30,
        0x14,0x01,0x00,0x00,0x0f,0xac,0x04,0x01,0x00,0x00,0x0f,0xac,0x04,0x01,0x00,0x00,
        0x0f,0xac,0x02,0x00,0x00};
    
    unsigned char mic[20]={0};
    int message2_len=121,
         mic_len=20;            
         
    ctx=HMAC_CTX_new();        
    HMAC_Init_ex(ctx,kck,kck_len,EVP_sha1(),NULL);
    HMAC_Update(ctx,message2,message2_len);
    HMAC_Final(ctx,mic,&mic_len);
    
    printf("\n");
    for(i=0;i<mic_len;i++)
        printf("%02X ",mic[i]);      
    printf("\n");
    
    return 0;
}
